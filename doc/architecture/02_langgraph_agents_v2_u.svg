<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1400 1300">
  <defs>
    <style>
      .title { font: bold 24px sans-serif; fill: #1a1a1a; }
      .subtitle { font: bold 16px sans-serif; fill: #2c3e50; }
      .text { font: 14px sans-serif; fill: #34495e; }
      .small-text { font: 12px sans-serif; fill: #555; }
      .box-router { fill: #fff3cd; stroke: #f39c12; stroke-width: 3; }
      .box-agent { fill: #d1ecf1; stroke: #0c5460; stroke-width: 2; }
      .box-new { fill: #d4edda; stroke: #28a745; stroke-width: 3; }
      .box-sub { fill: #f8d7da; stroke: #c82333; stroke-width: 2; }
      .box-user { fill: #e2e3e5; stroke: #6c757d; stroke-width: 2; }
      .arrow { stroke: #495057; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .arrow-intent { stroke: #e74c3c; stroke-width: 2; fill: none; marker-end: url(#arrowhead); stroke-dasharray: 5,5; }
      .arrow-loop { stroke: #28a745; stroke-width: 2; fill: none; marker-end: url(#arrowhead); stroke-dasharray: 3,3; }
      .label-intent { font: bold 13px sans-serif; fill: #e74c3c; }
      .label-new { font: bold 12px sans-serif; fill: #28a745; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#495057" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="700" y="40" text-anchor="middle" class="title">LangGraph Multi-Agent 상세 구조</text>

  <!-- User Input -->
  <rect x="575" y="80" width="250" height="60" rx="10" class="box-user"/>
  <text x="700" y="105" text-anchor="middle" class="subtitle">사용자 요청</text>
  <text x="700" y="125" text-anchor="middle" class="small-text">"골절 시 보장 여부?"</text>

  <!-- Arrow to Router -->
  <path d="M 700 140 L 700 190" class="arrow"/>

  <!-- Router Agent -->
  <rect x="525" y="190" width="350" height="100" rx="10" class="box-router"/>
  <text x="700" y="220" text-anchor="middle" class="subtitle">1. Router Agent (라우터)</text>
  <text x="700" y="245" text-anchor="middle" class="text">의도 분류 및 라우팅</text>
  <text x="700" y="265" text-anchor="middle" class="small-text">입력: 사용자 질의</text>
  <text x="700" y="280" text-anchor="middle" class="small-text">출력: 의도 분류 (search/upload/manage)</text>

  <!-- Intent Labels -->
  <text x="300" y="320" text-anchor="middle" class="label-intent">[search/질문]</text>
  <text x="700" y="320" text-anchor="middle" class="label-intent">[upload/업로드]</text>
  <text x="1100" y="320" text-anchor="middle" class="label-intent">[manage/관리]</text>

  <!-- Arrows to Agents -->
  <path d="M 600 290 L 300 350" class="arrow-intent"/>
  <path d="M 700 290 L 700 350" class="arrow-intent"/>
  <path d="M 800 290 L 1100 350" class="arrow-intent"/>

  <!-- Search Agent -->
  <rect x="80" y="350" width="440" height="210" rx="10" class="box-agent"/>
  <text x="300" y="380" text-anchor="middle" class="subtitle">2. Search Agent (검색)</text>
  <text x="300" y="400" text-anchor="middle" class="label-new">하이브리드 검색 강화</text>
  
  <rect x="110" y="420" width="180" height="125" rx="5" class="box-sub"/>
  <text x="200" y="440" text-anchor="middle" class="text">검색 처리</text>
  <text x="200" y="460" text-anchor="middle" class="small-text">• Query 전처리</text>
  <text x="200" y="475" text-anchor="middle" class="small-text">• 벡터 검색 (RRF)</text>
  <text x="200" y="490" text-anchor="middle" class="small-text">• 키워드 검색 (tsquery)</text>
  <text x="200" y="505" text-anchor="middle" class="small-text">• 결과 융합</text>
  <text x="200" y="520" text-anchor="middle" class="small-text">• 컨텍스트 최적화</text>
  <text x="200" y="535" text-anchor="middle" class="small-text">  (20K 토큰)</text>

  <rect x="310" y="420" width="190" height="125" rx="5" class="box-sub"/>
  <text x="405" y="440" text-anchor="middle" class="text">검색 결과</text>
  <text x="405" y="460" text-anchor="middle" class="small-text">• 관련 청크 목록</text>
  <text x="405" y="475" text-anchor="middle" class="small-text">• 유사도 점수</text>
  <text x="405" y="490" text-anchor="middle" class="small-text">• 문서 메타데이터</text>
  <text x="405" y="510" text-anchor="middle" class="small-text">→ Context Judgement</text>

  <!-- Arrow: Search to Context Judgement -->
  <path d="M 300 560 L 300 610" class="arrow"/>

  <!-- Context Judgement Agent (NEW) -->
  <rect x="80" y="610" width="440" height="150" rx="10" class="box-agent"/>
  <text x="300" y="640" text-anchor="middle" class="subtitle">3. Context Judgement Agent</text>
  <text x="300" y="660" text-anchor="middle" class="label-new">(컨텍스트 충분성 판단)</text>
  
  <rect x="110" y="680" width="380" height="65" rx="5" class="box-sub"/>
  <text x="300" y="700" text-anchor="middle" class="text">판단 기준</text>
  <text x="300" y="720" text-anchor="middle" class="small-text">• 검색 결과 개수 / 최고 유사도 점수 / 컨텍스트 토큰 수</text>
  <text x="300" y="735" text-anchor="middle" class="small-text">→ 충분: Answer Agent | 불충분: Chunk Expansion Agent</text>

  <!-- Conditional routing -->
  <text x="150" y="790" text-anchor="middle" class="label-intent">[충분]</text>
  <text x="450" y="790" text-anchor="middle" class="label-new">[불충분]</text>

  <path d="M 150 760 L 150 930" class="arrow"/>
  <path d="M 450 760 L 950 800" class="arrow"/>

  <!-- Chunk Expansion Agent (NEW) -->
  <rect x="640" y="800" width="620" height="170" rx="10" class="box-agent"/>
  <text x="950" y="830" text-anchor="middle" class="subtitle">4. Chunk Expansion Agent</text>
  <text x="950" y="850" text-anchor="middle" class="label-new">(청크 확장)</text>
  
  <rect x="670" y="870" width="260" height="85" rx="5" class="box-sub"/>
  <text x="800" y="890" text-anchor="middle" class="text">확장 전략</text>
  <text x="800" y="910" text-anchor="middle" class="small-text">• 인접 청크 가져오기</text>
  <text x="800" y="925" text-anchor="middle" class="small-text">  (이전/이후 chunk_index)</text>
  <text x="800" y="940" text-anchor="middle" class="small-text">• 같은 섹션 청크 추가</text>

  <rect x="950" y="870" width="290" height="85" rx="5" class="box-sub"/>
  <text x="1095" y="890" text-anchor="middle" class="text">제한 사항</text>
  <text x="1095" y="910" text-anchor="middle" class="small-text">• 최대 확장 횟수 (3회)</text>
  <text x="1095" y="925" text-anchor="middle" class="small-text">• 토큰 제한 준수 (20K)</text>
  <text x="1095" y="940" text-anchor="middle" class="small-text">→ 재판단: Context Judgement</text>

  <!-- Loop back to Context Judgement -->
  <path d="M 950 970 L 950 1000 L 520 1000 L 520 680 L 520 680" class="arrow-loop"/>
  <text x="730" y="1015" text-anchor="middle" class="label-new">재판단 루프</text>

  <!-- Answer Agent -->
  <rect x="80" y="930" width="440" height="240" rx="10" class="box-agent"/>
  <text x="150" y="960" text-anchor="middle" class="subtitle">5. Answer Agent</text>
  <text x="150" y="980" text-anchor="middle" class="label-new">4단계 검증</text>
  
  <rect x="110" y="1000" width="180" height="155" rx="5" class="box-sub"/>
  <text x="200" y="1020" text-anchor="middle" class="text">답변 생성</text>
  <text x="200" y="1040" text-anchor="middle" class="small-text">• 시스템 프롬프트</text>
  <text x="200" y="1055" text-anchor="middle" class="small-text">  - 정확성 보장</text>
  <text x="200" y="1070" text-anchor="middle" class="small-text">  - 근거 제시</text>
  <text x="200" y="1085" text-anchor="middle" class="small-text">  - 한계 인정</text>
  <text x="200" y="1105" text-anchor="middle" class="small-text">• 컨텍스트 조립</text>
  <text x="200" y="1120" text-anchor="middle" class="small-text">• GPT-4o 호출</text>
  <text x="200" y="1135" text-anchor="middle" class="small-text">  (temperature: 0.1)</text>

  <rect x="310" y="1000" width="190" height="155" rx="5" class="box-sub"/>
  <text x="405" y="1020" text-anchor="middle" class="text">4단계 검증</text>
  <text x="405" y="1040" text-anchor="middle" class="small-text">• 형식 검증 (10%)</text>
  <text x="405" y="1055" text-anchor="middle" class="small-text">• 조항 검증 (20%)</text>
  <text x="405" y="1070" text-anchor="middle" class="small-text">• 컨텍스트 일치 (30%)</text>
  <text x="405" y="1085" text-anchor="middle" class="small-text">• 할루시네이션 (40%)</text>
  <text x="405" y="1105" text-anchor="middle" class="small-text">→ 신뢰도 계산</text>
  <text x="405" y="1120" text-anchor="middle" class="small-text">→ 임계값 0.7</text>
  <text x="405" y="1135" text-anchor="middle" class="small-text">→ 미달 시 재생성</text>

  <!-- Processing Agent -->
  <rect x="580" y="350" width="240" height="240" rx="10" class="box-agent"/>
  <text x="700" y="380" text-anchor="middle" class="subtitle">6. Processing Agent</text>
  <text x="700" y="400" text-anchor="middle" class="subtitle">(전처리)</text>
  
  <rect x="600" y="420" width="200" height="160" rx="5" class="box-sub"/>
  <text x="700" y="445" text-anchor="middle" class="text">PDF 처리</text>
  <text x="700" y="465" text-anchor="middle" class="small-text">Path 1: 직접 추출</text>
  <text x="700" y="480" text-anchor="middle" class="small-text">• PyMuPDF4LLM</text>
  <text x="700" y="500" text-anchor="middle" class="small-text">Path 2: 멀티모달</text>
  <text x="700" y="515" text-anchor="middle" class="small-text">• GPT-4o Vision</text>
  <text x="700" y="535" text-anchor="middle" class="small-text">• 결과 병합 &amp; 검증</text>
  <text x="700" y="550" text-anchor="middle" class="small-text">• 청킹 &amp; 임베딩</text>
  <text x="700" y="565" text-anchor="middle" class="small-text">• 벡터 DB 저장</text>

  <!-- Management Agent -->
  <rect x="880" y="350" width="440" height="240" rx="10" class="box-agent"/>
  <text x="1100" y="380" text-anchor="middle" class="subtitle">7. Management Agent (관리)</text>
  
  <rect x="910" y="400" width="180" height="170" rx="5" class="box-sub"/>
  <text x="1000" y="425" text-anchor="middle" class="text">조회 기능</text>
  <text x="1000" y="445" text-anchor="middle" class="small-text">• 약관 목록 조회</text>
  <text x="1000" y="460" text-anchor="middle" class="small-text">• 필터링</text>
  <text x="1000" y="475" text-anchor="middle" class="small-text">  - 문서 타입</text>
  <text x="1000" y="490" text-anchor="middle" class="small-text">  - 보험사</text>
  <text x="1000" y="505" text-anchor="middle" class="small-text">  - 날짜 범위</text>
  <text x="1000" y="525" text-anchor="middle" class="small-text">• 정렬 &amp; 페이징</text>
  <text x="1000" y="540" text-anchor="middle" class="small-text">• PDF/MD 뷰어</text>

  <rect x="1110" y="400" width="190" height="170" rx="5" class="box-sub"/>
  <text x="1205" y="425" text-anchor="middle" class="text">관리 기능</text>
  <text x="1205" y="445" text-anchor="middle" class="small-text">• 약관 삭제</text>
  <text x="1205" y="460" text-anchor="middle" class="small-text">  - DB 레코드</text>
  <text x="1205" y="475" text-anchor="middle" class="small-text">  - 로컬 파일</text>
  <text x="1205" y="490" text-anchor="middle" class="small-text">  - 벡터 데이터</text>
  <text x="1205" y="510" text-anchor="middle" class="small-text">• 파일 다운로드</text>
  <text x="1205" y="525" text-anchor="middle" class="small-text">  - 원본 PDF</text>
  <text x="1205" y="540" text-anchor="middle" class="small-text">  - Markdown</text>

  <!-- Return Arrows -->
  <path d="M 300 1170 L 600 1220" class="arrow"/>
  <path d="M 700 590 L 700 1220" class="arrow"/>
  <path d="M 1100 590 L 800 1220" class="arrow"/>

  <!-- User Response -->
  <rect x="575" y="1220" width="250" height="50" rx="10" class="box-user"/>
  <text x="700" y="1250" text-anchor="middle" class="subtitle">사용자 응답</text>

</svg>

