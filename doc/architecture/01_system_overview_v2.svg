<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1200 950">
  <defs>
    <style>
      .title { font: bold 24px sans-serif; fill: #1a1a1a; }
      .subtitle { font: bold 16px sans-serif; fill: #2c3e50; }
      .text { font: 14px sans-serif; fill: #34495e; }
      .small-text { font: 12px sans-serif; fill: #555; }
      .label-new { font: bold 12px sans-serif; fill: #28a745; }
      .box { fill: #fff; stroke: #3498db; stroke-width: 2; }
      .box-frontend { fill: #e8f4f8; stroke: #3498db; stroke-width: 2; }
      .box-backend { fill: #fff5e6; stroke: #f39c12; stroke-width: 2; }
      .box-agent { fill: #e8f8f5; stroke: #16a085; stroke-width: 2; }
      .box-new { fill: #d4edda; stroke: #28a745; stroke-width: 3; }
      .box-service { fill: #f4ecf7; stroke: #8e44ad; stroke-width: 2; }
      .arrow { stroke: #2c3e50; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .arrow-bi { stroke: #2c3e50; stroke-width: 2; fill: none; marker-end: url(#arrowhead); marker-start: url(#arrowhead-start); }
      .arrow-cache { stroke: #28a745; stroke-width: 2; fill: none; marker-end: url(#arrowhead); stroke-dasharray: 3,3; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#2c3e50" />
    </marker>
    <marker id="arrowhead-start" markerWidth="10" markerHeight="10" refX="1" refY="3" orient="auto">
      <polygon points="10 0, 0 3, 10 6" fill="#2c3e50" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="600" y="40" text-anchor="middle" class="title">ISPL 시스템 아키텍처 전체 구조 v2 (7개 에이전트)</text>

  <!-- Frontend Layer -->
  <rect x="50" y="80" width="1100" height="150" rx="10" class="box-frontend"/>
  <text x="600" y="110" text-anchor="middle" class="subtitle">사용자 인터페이스 (Next.js 15.0.3 + React 18.3.1)</text>
  
  <rect x="100" y="130" width="280" height="80" rx="5" class="box"/>
  <text x="240" y="160" text-anchor="middle" class="text">채팅 화면 (메인)</text>
  <text x="240" y="180" text-anchor="middle" class="small-text">• 대화 입력/출력</text>
  <text x="240" y="195" text-anchor="middle" class="small-text">• 실시간 스트리밍</text>

  <rect x="420" y="130" width="280" height="80" rx="5" class="box"/>
  <text x="560" y="160" text-anchor="middle" class="text">약관 관리 화면</text>
  <text x="560" y="180" text-anchor="middle" class="small-text">• 업로드/삭제</text>
  <text x="560" y="195" text-anchor="middle" class="small-text">• 목록 조회</text>

  <rect x="740" y="130" width="280" height="80" rx="5" class="box"/>
  <text x="880" y="160" text-anchor="middle" class="text">대화 이력 ⭐</text>
  <text x="880" y="180" text-anchor="middle" class="small-text">• 세션 관리</text>
  <text x="880" y="195" text-anchor="middle" class="small-text">• 참조 문서 패널</text>

  <!-- Arrow: Frontend to Backend -->
  <path d="M 600 230 L 600 270" class="arrow"/>
  <text x="650" y="255" class="small-text">HTTP/WebSocket</text>

  <!-- Backend Layer -->
  <rect x="50" y="270" width="1100" height="450" rx="10" class="box-backend"/>
  <text x="600" y="300" text-anchor="middle" class="subtitle">FastAPI 0.115.0 + LangGraph 0.3.27+ Multi-Agent System (7개 에이전트)</text>

  <!-- Router Agent -->
  <rect x="420" y="320" width="360" height="60" rx="5" class="box-agent"/>
  <text x="600" y="345" text-anchor="middle" class="text">1. Router Agent (라우터)</text>
  <text x="600" y="365" text-anchor="middle" class="small-text">사용자 요청 분석 및 의도 분류 (search/upload/manage)</text>

  <!-- Arrows from Router -->
  <path d="M 480 380 L 180 420" class="arrow"/>
  <text x="300" y="395" class="small-text">search</text>
  
  <path d="M 600 380 L 600 420" class="arrow"/>
  <text x="620" y="405" class="small-text">upload</text>
  
  <path d="M 720 380 L 1020 420" class="arrow"/>
  <text x="900" y="395" class="small-text">manage</text>

  <!-- Search Branch (Left) -->
  <rect x="60" y="420" width="280" height="80" rx="5" class="box-agent"/>
  <text x="200" y="445" text-anchor="middle" class="text">2. Search Agent</text>
  <text x="200" y="465" text-anchor="middle" class="small-text">• 하이브리드 검색 (RRF)</text>
  <text x="200" y="480" text-anchor="middle" class="small-text">• 벡터 + 키워드</text>
  <text x="200" y="495" text-anchor="middle" class="small-text">• 최대 20K 토큰</text>

  <!-- Arrow: Search to Context Judgement -->
  <path d="M 200 500 L 200 520" class="arrow"/>

  <!-- Context Judgement Agent (NEW) -->
  <rect x="60" y="520" width="280" height="80" rx="5" class="box-new"/>
  <text x="200" y="545" text-anchor="middle" class="text">3. Context Judgement ⭐</text>
  <text x="200" y="565" text-anchor="middle" class="small-text">• 컨텍스트 충분성 판단</text>
  <text x="200" y="580" text-anchor="middle" class="small-text">• 불충분 시 확장</text>

  <!-- Chunk Expansion (NEW - Right side arrow) -->
  <path d="M 340 560 L 380 560" class="arrow-cache"/>
  <text x="360" y="550" class="label-new">확장</text>

  <!-- Chunk Expansion Agent (NEW) -->
  <rect x="380" y="530" width="180" height="60" rx="5" class="box-new"/>
  <text x="470" y="555" text-anchor="middle" class="text">4. Chunk</text>
  <text x="470" y="573" text-anchor="middle" class="text">Expansion ⭐</text>

  <!-- Arrow: Context to Answer -->
  <path d="M 200 600 L 200 630" class="arrow"/>

  <!-- Answer Agent -->
  <rect x="60" y="630" width="280" height="80" rx="5" class="box-agent"/>
  <text x="200" y="655" text-anchor="middle" class="text">5. Answer Agent</text>
  <text x="200" y="675" text-anchor="middle" class="small-text">• GPT-4o 답변 생성</text>
  <text x="200" y="690" text-anchor="middle" class="small-text">• 4단계 검증 ⭐</text>

  <!-- Processing Agent -->
  <rect x="460" y="420" width="280" height="120" rx="5" class="box-agent"/>
  <text x="600" y="445" text-anchor="middle" class="text">6. Processing Agent</text>
  <text x="600" y="465" text-anchor="middle" class="small-text">• Path 1: PyMuPDF4LLM</text>
  <text x="600" y="480" text-anchor="middle" class="small-text">• Path 2: GPT-4o Vision ⭐</text>
  <text x="600" y="495" text-anchor="middle" class="small-text">• 병합 &amp; 품질 검증</text>
  <text x="600" y="510" text-anchor="middle" class="small-text">• 청킹 &amp; 임베딩</text>
  <text x="600" y="525" text-anchor="middle" class="small-text">• 임베딩 캐싱 (Redis)</text>

  <!-- Management Agent -->
  <rect x="860" y="420" width="280" height="120" rx="5" class="box-agent"/>
  <text x="1000" y="445" text-anchor="middle" class="text">7. Management Agent</text>
  <text x="1000" y="465" text-anchor="middle" class="small-text">• 목록 조회</text>
  <text x="1000" y="480" text-anchor="middle" class="small-text">• 삭제 (CASCADE)</text>
  <text x="1000" y="495" text-anchor="middle" class="small-text">• 다운로드</text>
  <text x="1000" y="510" text-anchor="middle" class="small-text">• PDF/MD 뷰어</text>
  <text x="1000" y="525" text-anchor="middle" class="small-text">• 대화 이력 ⭐</text>

  <!-- Arrow: Backend to Services -->
  <path d="M 600 720 L 600 760" class="arrow"/>

  <!-- External Services Layer -->
  <rect x="50" y="760" width="1100" height="170" rx="10" class="box-service"/>
  <text x="600" y="790" text-anchor="middle" class="subtitle">외부 서비스 &amp; 데이터 저장소</text>

  <rect x="80" y="810" width="250" height="100" rx="5" class="box"/>
  <text x="205" y="840" text-anchor="middle" class="text">OpenAI API</text>
  <text x="205" y="860" text-anchor="middle" class="small-text">• GPT-4o (답변) ⭐</text>
  <text x="205" y="875" text-anchor="middle" class="small-text">• GPT-4o Vision ⭐</text>
  <text x="205" y="890" text-anchor="middle" class="small-text">• text-embedding-3-large</text>

  <rect x="370" y="810" width="250" height="100" rx="5" class="box"/>
  <text x="495" y="840" text-anchor="middle" class="text">PostgreSQL 17.6</text>
  <text x="495" y="860" text-anchor="middle" class="small-text">• pgvector 0.3.6 (HNSW)</text>
  <text x="495" y="875" text-anchor="middle" class="small-text">• chat_sessions ⭐</text>
  <text x="495" y="890" text-anchor="middle" class="small-text">• pdf_page_number ⭐</text>

  <rect x="660" y="810" width="200" height="100" rx="5" class="box"/>
  <text x="760" y="840" text-anchor="middle" class="text">MemoryCache</text>
  <text x="760" y="860" text-anchor="middle" class="small-text">• 임베딩 캐시 ⭐</text>
  <text x="760" y="875" text-anchor="middle" class="small-text">• LRU (10K 항목)</text>

  <rect x="900" y="810" width="220" height="100" rx="5" class="box"/>
  <text x="1010" y="840" text-anchor="middle" class="text">파일 시스템</text>
  <text x="1010" y="860" text-anchor="middle" class="small-text">• uploads/documents/</text>
  <text x="1010" y="875" text-anchor="middle" class="small-text">• uploads/images/</text>
  <text x="1010" y="890" text-anchor="middle" class="small-text">• uploads/temp/</text>

  <!-- Cache connection (dashed) -->
  <path d="M 600 540 L 760 760" class="arrow-cache"/>
  <text x="680" y="640" class="label-new">캐싱</text>

</svg>

