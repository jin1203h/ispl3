<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1850">
  <defs>
    <style>
      .title { font: bold 24px sans-serif; fill: #1a1a1a; }
      .subtitle { font: bold 16px sans-serif; fill: #2c3e50; }
      .text { font: 14px sans-serif; fill: #34495e; }
      .small-text { font: 12px sans-serif; fill: #555; }
      .box-input { fill: #e3f2fd; stroke: #1976d2; stroke-width: 2; }
      .box-preprocess { fill: #fff3e0; stroke: #f57c00; stroke-width: 2; }
      .box-search { fill: #f3e5f5; stroke: #7b1fa2; stroke-width: 2; }
      .box-hybrid { fill: #fce4ec; stroke: #c2185b; stroke-width: 2; }
      .box-new { fill: #d4edda; stroke: #28a745; stroke-width: 3; }
      .box-llm { fill: #e8f5e9; stroke: #388e3c; stroke-width: 2; }
      .box-verify { fill: #fff9c4; stroke: #f57f17; stroke-width: 2; }
      .box-output { fill: #e0f2f1; stroke: #00796b; stroke-width: 2; }
      .arrow { stroke: #424242; stroke-width: 2; fill: none; marker-end: url(#arrowhead); }
      .arrow-loop { stroke: #28a745; stroke-width: 2; fill: none; marker-end: url(#arrowhead); stroke-dasharray: 3,3; }
      .label-new { font: bold 12px sans-serif; fill: #28a745; }
    </style>
    <marker id="arrowhead" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
      <polygon points="0 0, 10 3, 0 6" fill="#424242" />
    </marker>
  </defs>

  <!-- Title -->
  <text x="500" y="40" text-anchor="middle" class="title">ê²€ìƒ‰ ë° ë‹µë³€ ìƒì„± í”Œë¡œìš°</text>

  <!-- User Query -->
  <rect x="300" y="80" width="400" height="70" rx="10" class="box-input"/>
  <text x="500" y="110" text-anchor="middle" class="subtitle">1. ì‚¬ìš©ì ì§ˆì˜</text>
  <text x="500" y="135" text-anchor="middle" class="small-text">"ê³¨ì ˆ ì‹œ ë³´í—˜ê¸ˆì„ ì–¼ë§ˆë‚˜ ë°›ì„ ìˆ˜ ìˆë‚˜ìš”?"</text>

  <path d="M 500 150 L 500 190" class="arrow"/>

  <!-- Router Agent -->
  <rect x="325" y="190" width="350" height="60" rx="10" class="box-preprocess"/>
  <text x="500" y="217" text-anchor="middle" class="subtitle">2. Router Agent (ì˜ë„ ë¶„ì„)</text>
  <text x="500" y="237" text-anchor="middle" class="small-text">task_type = "search" íŒë‹¨</text>

  <path d="M 500 250 L 500 290" class="arrow"/>

  <!-- Query Preprocessing (ENHANCED) -->
  <rect x="200" y="290" width="600" height="130" rx="10" class="box-preprocess"/>
  <text x="500" y="320" text-anchor="middle" class="subtitle">3. Query ì „ì²˜ë¦¬</text>
  <text x="500" y="340" text-anchor="middle" class="label-new">(QueryPreprocessor)</text>
  <text x="500" y="363" text-anchor="middle" class="small-text">â€¢ ì •ê·œí™”: ê³µë°± ì²˜ë¦¬</text>
  <text x="500" y="380" text-anchor="middle" class="small-text">â€¢ í‘œì¤€í™”: "ë³´í—˜ê¸ˆ/ê¸‰ì—¬ê¸ˆ" â†’ "ë³´í—˜ê¸ˆ" (insurance_terms.json)</text>
  <text x="500" y="397" text-anchor="middle" class="small-text">â€¢ ë™ì˜ì–´ í™•ì¥: "ê³¨ì ˆ" + "ë¼ˆë¶€ëŸ¬ì§"</text>
  <text x="500" y="414" text-anchor="middle" class="small-text">â€¢ í‚¤ì›Œë“œ ì¶”ì¶œ: ì¡°ì‚¬ ì œê±°</text>

  <path d="M 500 420 L 500 460" class="arrow"/>

  <!-- Query Embedding -->
  <rect x="325" y="460" width="350" height="60" rx="10" class="box-preprocess"/>
  <text x="500" y="487" text-anchor="middle" class="subtitle">4. ì¿¼ë¦¬ ì„ë² ë”© ìƒì„±</text>
  <text x="500" y="507" text-anchor="middle" class="small-text">text-embedding-3-large (1536ì°¨ì›)</text>

  <path d="M 500 520 L 500 560" class="arrow"/>

  <!-- Hybrid Search (ENHANCED) -->
  <rect x="150" y="560" width="700" height="280" rx="10" class="box-search"/>
  <text x="500" y="590" text-anchor="middle" class="subtitle">5. í•˜ì´ë¸Œë¦¬ë“œ ê²€ìƒ‰</text>
  <text x="500" y="610" text-anchor="middle" class="label-new">(HybridSearchService)</text>

  <rect x="180" y="630" width="290" height="180" rx="5" class="box-hybrid"/>
  <text x="325" y="655" text-anchor="middle" class="text">ë²¡í„° ê²€ìƒ‰</text>
  <text x="325" y="678" text-anchor="middle" class="small-text">â€¢ VectorSearchService</text>
  <text x="325" y="695" text-anchor="middle" class="small-text">â€¢ pgvector ì½”ì‚¬ì¸ ìœ ì‚¬ë„</text>
  <text x="325" y="712" text-anchor="middle" class="small-text">â€¢ HNSW ì¸ë±ìŠ¤ í™œìš©</text>
  <text x="325" y="729" text-anchor="middle" class="small-text">â€¢ Top-K í›„ë³´ (K=20)</text>
  <text x="325" y="746" text-anchor="middle" class="small-text">â€¢ ìœ ì‚¬ë„ ì„ê³„ê°’ > 0.7</text>
  <text x="325" y="763" text-anchor="middle" class="small-text">â€¢ Cosine Similarity</text>
  <text x="325" y="795" text-anchor="middle" class="text">â†’ ë²¡í„° ê²€ìƒ‰ ê²°ê³¼</text>

  <rect x="530" y="630" width="290" height="180" rx="5" class="box-hybrid"/>
  <text x="675" y="655" text-anchor="middle" class="text">í‚¤ì›Œë“œ ê²€ìƒ‰</text>
  <text x="675" y="678" text-anchor="middle" class="small-text">â€¢ PostgreSQL Full-Text</text>
  <text x="675" y="695" text-anchor="middle" class="small-text">â€¢ tsquery ìƒì„±</text>
  <text x="675" y="712" text-anchor="middle" class="small-text">â€¢ í‚¤ì›Œë“œ AND ì—°ì‚°</text>
  <text x="675" y="729" text-anchor="middle" class="small-text">â€¢ ì¡°ì‚¬ ì œê±° (extract_keywords)</text>
  <text x="675" y="746" text-anchor="middle" class="small-text">â€¢ tsvector ë§¤ì¹­</text>
  <text x="675" y="795" text-anchor="middle" class="text">â†’ í‚¤ì›Œë“œ ê²€ìƒ‰ ê²°ê³¼</text>

  <path d="M 325 810 L 425 860" class="arrow"/>
  <path d="M 675 810 L 575 860" class="arrow"/>

  <!-- RRF Fusion -->
  <rect x="330" y="860" width="340" height="65" rx="5" class="box-hybrid"/>
  <text x="500" y="885" text-anchor="middle" class="text">RRF ìœµí•© &amp; ì¬ìˆœìœ„í™”</text>
  <text x="500" y="905" text-anchor="middle" class="small-text">Reciprocal Rank Fusion (K=60)</text>
  <text x="500" y="920" text-anchor="middle" class="small-text">ë²¡í„° + í‚¤ì›Œë“œ ê²°ê³¼ í†µí•©</text>

  <path d="M 500 925 L 500 965" class="arrow"/>

  <!-- Context Optimization -->
  <rect x="200" y="965" width="600" height="90" rx="10" class="box-search"/>
  <text x="500" y="995" text-anchor="middle" class="subtitle">6. ì»¨í…ìŠ¤íŠ¸ ìµœì í™”</text>
  <text x="500" y="1018" text-anchor="middle" class="small-text">â€¢ ìµœëŒ€ í† í° ì œí•œ: 20,000 í† í° (GPT-4o)</text>
  <text x="500" y="1035" text-anchor="middle" class="small-text">â€¢ tiktokenìœ¼ë¡œ í† í° ì¹´ìš´íŒ… (cl100k_base)</text>
  <text x="500" y="1052" text-anchor="middle" class="small-text">â€¢ ë¬¸ì„œ ë©”íƒ€ë°ì´í„° í¬í•¨ (ì¡°í•­ ë²ˆí˜¸, í˜ì´ì§€)</text>

  <path d="M 500 1055 L 500 1095" class="arrow"/>

  <!-- Context Judgement (NEW) -->
  <rect x="200" y="1095" width="600" height="100" rx="10" class="box-search"/>
  <text x="500" y="1125" text-anchor="middle" class="subtitle">7. ì»¨í…ìŠ¤íŠ¸ íŒë‹¨</text>
  <text x="500" y="1145" text-anchor="middle" class="label-new">(Context Judgement Agent)</text>
  <text x="500" y="1168" text-anchor="middle" class="small-text">ì¶©ë¶„ì„± í‰ê°€: ê²°ê³¼ ê°œìˆ˜ / ìµœê³  ìœ ì‚¬ë„ / í† í° ìˆ˜</text>
  <text x="500" y="1185" text-anchor="middle" class="small-text">â†’ ë¶ˆì¶©ë¶„ ì‹œ: Chunk Expansion Agent</text>

  <path d="M 500 1195 L 500 1235" class="arrow"/>
  
  <!-- Note for loop -->
  <text x="820" y="1145" class="label-new">[ë¶ˆì¶©ë¶„ ì‹œ]</text>
  <path d="M 800 1125 L 920 1125 L 920 1165" class="arrow-loop"/>
  
  <!-- Chunk Expansion (NEW) -->
  <rect x="825" y="1165" width="325" height="90" rx="10" class="box-search"/>
  <text x="987" y="1195" text-anchor="middle" class="subtitle">Chunk Expansion</text>
  <text x="987" y="1215" text-anchor="middle" class="small-text">ì¸ì ‘ ì²­í¬ í™•ì¥ / ì¬íŒë‹¨ ë£¨í”„</text>
  <text x="987" y="1232" text-anchor="middle" class="small-text">ìµœëŒ€ 3íšŒ / 20K í† í° ì œí•œ</text>

  <!-- Prompt Assembly -->
  <rect x="200" y="1235" width="600" height="90" rx="10" class="box-llm"/>
  <text x="500" y="1265" text-anchor="middle" class="subtitle">8. í”„ë¡¬í”„íŠ¸ ì¡°ë¦½</text>
  <text x="500" y="1288" text-anchor="middle" class="small-text">â€¢ ì‹œìŠ¤í…œ í”„ë¡¬í”„íŠ¸ (ì •í™•ì„±, ê·¼ê±° ì œì‹œ, í•œê³„ ì¸ì •)</text>
  <text x="500" y="1305" text-anchor="middle" class="small-text">â€¢ ì»¨í…ìŠ¤íŠ¸ (ê²€ìƒ‰ëœ ì²­í¬ë“¤)</text>
  <text x="500" y="1322" text-anchor="middle" class="small-text">â€¢ ì‚¬ìš©ì ì§ˆì˜</text>

  <path d="M 500 1325 L 500 1365" class="arrow"/>

  <!-- GPT-4o Call -->
  <rect x="325" y="1365" width="350" height="70" rx="10" class="box-llm"/>
  <text x="500" y="1395" text-anchor="middle" class="subtitle">9. GPT-4o í˜¸ì¶œ</text>
  <text x="500" y="1418" text-anchor="middle" class="small-text">temperature: 0.1 (ì •í™•ì„± ìš°ì„ )</text>

  <path d="M 500 1435 L 500 1475" class="arrow"/>

  <!-- 4-Stage Verification (ENHANCED) -->
  <rect x="150" y="1475" width="700" height="155" rx="10" class="box-verify"/>
  <text x="500" y="1505" text-anchor="middle" class="subtitle">10. 4ë‹¨ê³„ ê²€ì¦</text>
  <text x="500" y="1525" text-anchor="middle" class="label-new">(AnswerValidator - ê°€ì¤‘ í‰ê· )</text>
  <text x="500" y="1548" text-anchor="middle" class="small-text">â‘  í˜•ì‹ ê²€ì¦ (10%): êµ¬ì¡°í™” / ì°¸ì¡° ë²ˆí˜¸ / ì¡°í•­ ë²ˆí˜¸ í¬í•¨</text>
  <text x="500" y="1565" text-anchor="middle" class="small-text">â‘¡ ì¡°í•­ ê²€ì¦ (20%): DB ì¡°íšŒë¡œ ì‹¤ì œ ì¡´ì¬ í™•ì¸</text>
  <text x="500" y="1582" text-anchor="middle" class="small-text">â‘¢ ì»¨í…ìŠ¤íŠ¸ ì¼ì¹˜ë„ (30%): ìœ ì‚¬ë„ ê³„ì‚°</text>
  <text x="500" y="1599" text-anchor="middle" class="small-text">â‘£ í• ë£¨ì‹œë„¤ì´ì…˜ ê²€ì¦ (40%): GPT-4oë¡œ ì‚¬ì‹¤ í™•ì¸ ë° ì¬ëŒ€ì¡°</text>
  <text x="500" y="1616" text-anchor="middle" class="small-text">â†’ ìµœì¢… ì‹ ë¢°ë„ ê³„ì‚° / ì„ê³„ê°’ 0.7 / ë¯¸ë‹¬ ì‹œ ì¬ìƒì„±</text>

  <path d="M 500 1630 L 500 1670" class="arrow"/>

  <!-- Response Formatting -->
  <rect x="250" y="1670" width="500" height="90" rx="10" class="box-output"/>
  <text x="500" y="1700" text-anchor="middle" class="subtitle">11. ì‘ë‹µ í¬ë§·íŒ…</text>
  <text x="500" y="1723" text-anchor="middle" class="small-text">ğŸ“Œ ë‹µë³€: "ê³¨ì ˆ ì‹œ XXXë§Œì›ê¹Œì§€ ë³´ì¥ë©ë‹ˆë‹¤." [ì°¸ì¡° 1]</text>
  <text x="500" y="1740" text-anchor="middle" class="small-text">ğŸ“‹ ê´€ë ¨ ì•½ê´€: [ì°¸ì¡° 1] ë¬¸ì„œëª… | í˜ì´ì§€ | ì¡°í•­</text>
  <text x="500" y="1757" text-anchor="middle" class="small-text">âš ï¸ ì£¼ì˜ì‚¬í•­: "ë‹¨, ë©´ì±…ì‚¬ìœ ì— í•´ë‹¹ ì‹œ ì œì™¸"</text>

  <path d="M 500 1760 L 500 1790" class="arrow"/>

  <!-- Final Response -->
  <rect x="300" y="1790" width="400" height="40" rx="10" class="box-output"/>
  <text x="500" y="1815" text-anchor="middle" class="subtitle">12. ì‚¬ìš©ìì—ê²Œ ì „ë‹¬</text>

</svg>

